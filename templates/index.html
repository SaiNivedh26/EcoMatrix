<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoMatrix - Location Finder</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            padding: 30px;
            max-width: 1200px;
        }
        .map-container {
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .control-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .location-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
        }
        .location-card:hover {
            transform: translateY(-2px);
        }
        .btn-voice {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: none;
            border-radius: 50px;
            color: white;
            padding: 10px 20px;
            margin: 5px;
        }
        .btn-voice:hover {
            background: linear-gradient(45deg, #ee5a52, #ff6b6b);
            color: white;
        }
        .ai-analysis {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner-border {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <div class="text-center mb-4">
                <h1 class="display-4 text-primary"><i class="fas fa-map-marker-alt"></i> EcoMatrix</h1>
                <p class="lead text-muted">Smart Location Finder with AI Analysis</p>
            </div>

            <!-- Map Container -->
            <div class="map-container" id="map-container">
                <div class="loading" id="map-loading">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading map...</span>
                    </div>
                    <p>Loading interactive map...</p>
                </div>
            </div>

            <!-- Service Area Info -->
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle"></i> Service Area Information</h6>
                <p class="mb-2">EcoMatrix operates within a fixed area (marked in red on the map). All searches and random locations are restricted to this service area.</p>
                <small class="text-muted">
                    <strong>Bounds:</strong> North: 40.7228° | South: 40.7028° | East: -73.9960° | West: -74.0160°
                </small>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="fas fa-crosshairs"></i> Your Location</h5>
                        <div class="input-group mb-3">
                            <input type="number" class="form-control" id="user-lat" placeholder="Latitude" step="any">
                            <input type="number" class="form-control" id="user-lng" placeholder="Longitude" step="any">
                        </div>
                        <button class="btn btn-primary" onclick="getRandomLocation()">
                            <i class="fas fa-dice"></i> Random Location (Within Area)
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="testServer()">
                            <i class="fas fa-wifi"></i> Test Server
                        </button>
                        <div id="random-point-status" class="mt-2" style="display: none;">
                            <small class="text-success">
                                <i class="fas fa-map-marker-alt"></i> 
                                <span id="random-point-coords"></span> displayed on map
                            </small>
                        </div>
                        <button class="btn btn-success" onclick="getUserLocation()">
                            <i class="fas fa-location-arrow"></i> Use My Location
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-search"></i> Search Query</h5>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="search-query" placeholder="What are you looking for?">
                            <button class="btn btn-voice" onclick="startVoiceInput()">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                        <button class="btn btn-primary btn-lg" onclick="findNearbyLocations()">
                            <i class="fas fa-search"></i> Find Nearby
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results-section" style="display: none;">
                <h4><i class="fas fa-list"></i> Nearby Locations</h4>
                <div id="locations-list"></div>
                
                <div class="ai-analysis" id="ai-analysis" style="display: none;">
                    <h5><i class="fas fa-robot"></i> AI Analysis</h5>
                    <div id="ai-content"></div>
                    <button class="btn btn-light btn-sm mt-3" onclick="speakAnalysis()">
                        <i class="fas fa-volume-up"></i> Speak Analysis
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="search-loading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Searching...</span>
                </div>
                <p>Analyzing locations and generating insights...</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentAnalysis = '';

        // Load map on page load
        window.onload = function() {
            loadMap();
            
            // Add event listeners to coordinate inputs
            document.getElementById('user-lat').addEventListener('input', clearRandomPointStatus);
            document.getElementById('user-lng').addEventListener('input', clearRandomPointStatus);
        };

        function loadMap() {
            document.getElementById('map-loading').style.display = 'block';
            
            // Clear any existing random point status
            clearRandomPointStatus();
            
            fetch('/api/map')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('map-container').innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading map:', error);
                    document.getElementById('map-container').innerHTML = 
                        '<div class="alert alert-danger">Error loading map</div>';
                });
        }

        function getRandomLocation() {
            console.log('Requesting random location...');
            
            // Clear any previous error states
            const mapContainer = document.getElementById('map-container');
            if (mapContainer && mapContainer.querySelector('.alert-danger')) {
                loadMap(); // Reload map if there was a previous error
                return;
            }
            
            fetch('/api/random-location')
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Random location data:', data);
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    document.getElementById('user-lat').value = data.lat.toFixed(6);
                    document.getElementById('user-lng').value = data.lng.toFixed(6);
                    
                    // Show service area info
                    if (data.service_area) {
                        const info = `Random location generated within service area:\nLat: ${data.lat.toFixed(6)}, Lng: ${data.lng.toFixed(6)}\n\nService Area Bounds:\nNorth: ${data.service_area.north}\nSouth: ${data.service_area.south}\nEast: ${data.service_area.east}\nWest: ${data.service_area.west}`;
                        console.log(info);
                    }
                    
                    // Update the map to show the random point
                    updateMapWithPoint(data.lat, data.lng);
                })
                .catch(error => {
                    console.error('Error getting random location:', error);
                    const errorMsg = `Error getting random location: ${error.message}\n\nPlease check if the server is running and try again.`;
                    alert(errorMsg);
                });
        }

        function updateMapWithPoint(lat, lng) {
            // Show loading state in the map container
            const mapContainer = document.getElementById('map-container');
            if (mapContainer) {
                mapContainer.innerHTML = `
                    <div class="loading" style="display: block;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Updating map...</span>
                        </div>
                        <p>Updating map with random point...</p>
                    </div>
                `;
            }
            
            // Fetch new map with the random point marked
            fetch(`/api/map-with-point?lat=${lat}&lng=${lng}`)
                .then(response => response.text())
                .then(html => {
                    if (mapContainer) {
                        mapContainer.innerHTML = html;
                    }
                    
                    // Show status indicator
                    const statusElement = document.getElementById('random-point-status');
                    const coordsElement = document.getElementById('random-point-coords');
                    
                    if (statusElement && coordsElement) {
                        coordsElement.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        statusElement.style.display = 'block';
                    }
                    
                    // Show success message
                    const successMsg = `✅ Random point generated and displayed on map!\nLat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}\n\nThis purple marker shows your random location within the service area.`;
                    console.log(successMsg);
                })
                .catch(error => {
                    console.error('Error updating map:', error);
                    
                    // Show error in map container
                    if (mapContainer) {
                        mapContainer.innerHTML = `
                            <div class="alert alert-danger">
                                <h5><i class="fas fa-exclamation-triangle"></i> Error Loading Map</h5>
                                <p>Failed to update map with random point: ${error.message}</p>
                                <button class="btn btn-primary" onclick="loadMap()">Reload Map</button>
                            </div>
                        `;
                    }
                    
                    alert('Error updating map with random point');
                });
        }

        function clearRandomPointStatus() {
            document.getElementById('random-point-status').style.display = 'none';
        }

        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    document.getElementById('user-lat').value = position.coords.latitude.toFixed(6);
                    document.getElementById('user-lng').value = position.coords.longitude.toFixed(6);
                    clearRandomPointStatus();
                }, function(error) {
                    alert('Error getting your location: ' + error.message);
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }

        function startVoiceInput() {
            const btn = event.target.closest('button');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            fetch('/api/voice/listen', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('search-query').value = data.text;
                    } else {
                        alert('Voice input error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Voice input error:', error);
                    alert('Voice input failed');
                })
                .finally(() => {
                    btn.innerHTML = '<i class="fas fa-microphone"></i>';
                    btn.disabled = false;
                });
        }

        function findNearbyLocations() {
            const lat = parseFloat(document.getElementById('user-lat').value);
            const lng = parseFloat(document.getElementById('user-lng').value);
            const query = document.getElementById('search-query').value;

            if (isNaN(lat) || isNaN(lng)) {
                alert('Please enter valid coordinates');
                return;
            }

            document.getElementById('search-loading').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';

            fetch('/api/find-nearby', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    lat: lat,
                    lng: lng,
                    query: query
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    if (data.error.includes('outside the service area')) {
                        alert(`Location is outside the service area!\n\nYour location: ${data.user_location.lat.toFixed(6)}, ${data.user_location.lng.toFixed(6)}\n\nService Area:\nNorth: ${data.service_area.north}\nSouth: ${data.service_area.south}\nEast: ${data.service_area.east}\nWest: ${data.service_area.west}\n\nPlease use "Random Location" to get coordinates within the service area.`);
                    } else {
                        alert('Error: ' + data.error);
                    }
                    return;
                }
                displayResults(data);
            })
            .catch(error => {
                console.error('Error finding locations:', error);
                alert('Error finding nearby locations');
            })
            .finally(() => {
                document.getElementById('search-loading').style.display = 'none';
            });
        }

        function displayResults(data) {
            const locationsList = document.getElementById('locations-list');
            const aiAnalysis = document.getElementById('ai-analysis');
            const aiContent = document.getElementById('ai-content');

            // Display locations
            locationsList.innerHTML = '';
            data.nearest_locations.forEach((location, index) => {
                const card = document.createElement('div');
                card.className = 'location-card';
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-${location.type === 'house' ? 'home' : 'store'}"></i>
                                ${location.name}
                            </h6>
                            <p class="mb-1 text-muted">${location.description}</p>
                            <small class="text-primary">
                                <i class="fas fa-map-marker-alt"></i>
                                ${location.distance} km away
                            </small>
                        </div>
                        <span class="badge bg-${location.type === 'house' ? 'danger' : 'primary'} rounded-pill">
                            #${index + 1}
                        </span>
                    </div>
                `;
                locationsList.appendChild(card);
            });

            // Display AI analysis
            if (data.ai_analysis) {
                currentAnalysis = data.ai_analysis;
                aiContent.innerHTML = data.ai_analysis.replace(/\n/g, '<br>');
                aiAnalysis.style.display = 'block';
            }

            document.getElementById('results-section').style.display = 'block';
        }

        function speakAnalysis() {
            if (!currentAnalysis) {
                alert('No analysis to speak');
                return;
            }

            fetch('/api/voice/speak', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: currentAnalysis
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Speech error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Speech error:', error);
                alert('Speech failed');
            });
        }

        function testServer() {
            console.log('Testing server connection...');
            
            fetch('/api/test')
                .then(response => response.json())
                .then(data => {
                    console.log('Server test response:', data);
                    alert(`Server Status: ${data.status}\nMessage: ${data.message}\nTimestamp: ${data.timestamp}`);
                })
                .catch(error => {
                    console.error('Server test error:', error);
                    alert(`Server test failed: ${error.message}`);
                });
        }
    </script>
</body>
</html>
